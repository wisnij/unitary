name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  lint:
    uses: ./.github/workflows/lint.yml

  test:
    uses: ./.github/workflows/test.yml
    needs: lint

  release:
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.x'
          channel: stable
          cache: true
      - run: flutter pub get
      - name: Set BUILD_METADATA
        run: |
          BUILD_TIMESTAMP=$(date -u +%Y%m%d-%H%M%S)
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "BUILD_METADATA=${BUILD_TIMESTAMP}.${SHORT_SHA}" >> $GITHUB_ENV
      - name: Build web
        run: >-
          flutter build web
          --dart-define=BUILD_METADATA=${{ env.BUILD_METADATA }}
          --release
          --wasm
      - name: Zip web build
        run: zip -r unitary-${{ github.ref_name }}-web.zip build/web
      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
        run: >-
          gh release create ${{ github.ref_name }}
          --notes-from-tag
          unitary-${{ github.ref_name }}-web.zip
